dist: trusty
sudo: required
language: java
jdk:
  - openjdk8
  - oraclejdk8
env:
    - MONGODB_VER=mongodb-linux-x86_64-2.6.12 ANT_TEST=test               WIRED_TIGER=false
    - MONGODB_VER=mongodb-linux-x86_64-3.4.18 ANT_TEST=test_mongo_storage WIRED_TIGER=false
    - MONGODB_VER=mongodb-linux-x86_64-3.4.18 ANT_TEST=test_mongo_storage WIRED_TIGER=true
    - MONGODB_VER=mongodb-linux-x86_64-3.6.8  ANT_TEST=test_mongo_storage WIRED_TIGER=false
    - MONGODB_VER=mongodb-linux-x86_64-3.6.8  ANT_TEST=test_mongo_storage WIRED_TIGER=true

before_install:
  - sudo apt-get -qq update
  - sudo apt-get install -y ant-optional

install:
  - cd ..
  - git clone https://github.com/kbase/jars
  - cd -

script:
  - cd ..
  - wget http://fastdl.mongodb.org/linux/$MONGODB_VER.tgz
  - tar xfz $MONGODB_VER.tgz
  - export MONGOD=`pwd`/$MONGODB_VER/bin/mongod
  - cd -
  - cp -n test.cfg.example test.cfg
  - sed -i "s#^test.temp.dir=.*#test.temp.dir=temp_test_dir#" test.cfg
  - sed -i "s#^test.mongo.exe.*#test.mongo.exe=$MONGOD#" test.cfg
  - sed -i "s#^test.mongo.wired_tiger.*#test.mongo.wired_tiger=$WIRED_TIGER#" test.cfg
  - cat test.cfg
  - ant $ANT_TEST

jobs:
  include:
    - stage: dockertest
      script: # Only push to dockerhub if this isn't a PR and we're updating master or develop	
        - docker pull kbase/kb_jre	
        - ant docker_image
after_success:
  - ls test-reports
  - bash <(curl -s https://codecov.io/bash) -t 05721a16-048a-43d1-9647-144b5249ebd0 -f test-reports/coverage-report.xml

